<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>じゃんけんゲーム</title>
    <style>
        button { margin: 5px; padding: 10px; font-size: 16px; }
        .game-container {
            display: flex;
            width: 80%;
            margin: auto;
        }
        .left-panel {
            width: 50%;
            padding: 20px;
            text-align: center;
        }
        .right-panel {
            width: 50%;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .hands {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 20px;
        }
        .hands img {
            width: 120px;
            height: 120px;
        }    
        .rotate-image {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    
    <div class="game-container">
        <div class="left-panel">
            <h1>じゃんけんゲーム</h1>
            <h3>成績</h3>
            <ul id="scores"></ul>
            <p>ボタン入力:</p>
            <button onclick="playGame('グー')">グー</button>
            <button onclick="playGame('チョキ')">チョキ</button>
            <button onclick="playGame('パー')">パー</button>
            <p>キーボード入力: ←: グー | ↓: チョキ | →: パー</p>
        </div>
    
        <div class="right-panel">
            <div class="hands">
                <div>
                    <p>相手の手</p>
                    <img id="computer-hand" src="" alt="相手の手" class="rotate-image">
                </div>
                <ul id="wld"></ul>
                <div>
                    <img id="player-hand" src="" alt="あなたの手">
                    <p>あなたの手</p>
                </div>
            </div>
        </div>
    </div>
    


    <script>
        const choices = ['グー', 'チョキ', 'パー'];
        let gameResults = [];
        let maxCount = 20;
        let opponentID = generateOpponentID();
        let wins = 0;
        let loses = 0;
        let draws = 0;

        const handImages = {
            "グー": "img/janken_gu.png",
            "チョキ": "img/janken_choki.png",
            "パー": "img/janken_pa.png"
        };

        resetGame();

        function playGame(playerChoice) {

            const computerChoice = choices[Math.floor(Math.random() * 3)];
            let result = '';
            if (playerChoice === computerChoice) {
                result = '引き分け';
                draws += 1
            } else if (
                (playerChoice === 'グー' && computerChoice === 'チョキ') ||
                (playerChoice === 'チョキ' && computerChoice === 'パー') ||
                (playerChoice === 'パー' && computerChoice === 'グー')
            ) {
                result = '勝ち';
                wins += 1
            } else {
                result = '負け';
                loses += 1
            }

            
            gameResults.push([opponentID, string2number(playerChoice), string2number(computerChoice), string2number(result)]);
            document.getElementById("scores").innerHTML = `勝ち: ${wins}/${maxCount}, 負け: ${loses}/${maxCount}, 引き分け: ${draws}/${maxCount}`;
            document.getElementById("player-hand").src = handImages[playerChoice];
            document.getElementById("computer-hand").src = handImages[computerChoice];
            document.getElementById("wld").innerHTML = result;

            if (gameResults.length === maxCount) {
                sendResultsToSheet();
                resetGame();

                alert("勝負が終了しました．リセットします．");
            }
        }


        function generateOpponentID() {
            return Math.floor(Math.random() * 100000);
        }

        function resetGame() {
            gameResults = [];
            draws = 0;
            wins = 0;
            loses = 0;
            opponentID = generateOpponentID();
            document.getElementById("scores").innerHTML = `勝ち: ${wins}/${maxCount}, 負け: ${loses}/${maxCount}, 引き分け: ${draws}/${maxCount}`;
            document.getElementById("player-hand").src = "img/mark_question.png";
            document.getElementById("computer-hand").src = "img/mark_question.png";
            document.getElementById("wld").innerHTML = "";
        }

        function string2number(str) {
            if (str === "グー") {
                return 0;
            } else if (str === "チョキ") {
                return 1;
            } else if (str === "パー") {
                return 2;
            }

            if (str === "勝ち") {
                return 1;
            } else if (str === "引き分け") {
                return 0;
            } else if (str === "負け") {
                return -1;
            }
        }


        
        function sendResultsToSheet() {
            fetch("https://script.google.com/macros/s/AKfycbz1GBmKlrfGWxXjNBxE9XiRWZ6yR6ul0x92qaZJVJicBrdS_qxVRGTuIZ8gV6I7PaVL/exec", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                mode: "no-cors",
                body: JSON.stringify(gameResults)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => alert("データをスプレッドシートに送信しました！"))
            .catch(error => {
                console.error("fetch エラー:", error);
            });
        }

        document.addEventListener("keydown", function(event) {
            console.log("Key pressed: ", event.key);    
            if (event.key === "ArrowLeft") {
                playGame("グー");
            } else if (event.key === "ArrowDown") {
                playGame("チョキ");
            } else if (event.key === "ArrowRight") {
                playGame("パー");
            }
        });

    </script>

</body>
</html>
